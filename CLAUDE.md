# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a NixOS homeserver configuration using Nix flakes for declarative infrastructure-as-code. The server (hostname: "mel") runs three main services: Home Assistant, a monitoring stack (Grafana/Loki/Prometheus), and Fava (Beancount accounting interface).

## Essential Commands

### Development & Deployment

```bash
# Deploy configuration changes to remote server
just deploy

# Update flake dependencies
just update

# Provision server from scratch (destructive!)
just provision

# SSH into the server
just ssh
just ssh ls # run a command directly

# Create SSH tunnel for service access (substitute port)
just tunnel 8123
```

### Testing Configuration

```bash
# Build configuration without deploying
nix build .#nixosConfigurations.mel.config.system.build.toplevel

# Check flake for errors
nix flake check

# Evaluate specific configuration options
nix eval .#nixosConfigurations.mel.config.system.stateVersion
```

## Architecture

### Flake Structure

- **flake.nix**: Main entry point defining the `mel` NixOS configuration
- **flake.lock**: Pinned to nixos-unstable channel
- **inputs**: nixpkgs (unstable), disko (disk partitioning), nix-index-database (command-not-found)

### Directory Layout

```
hosts/mel/
├── configuration.nix      # System-level config (networking, users, SSH, Caddy)
├── disko.nix             # Disk partitioning (1GB EFI + ext4 root)
├── custom-services.nix   # Service enablement with options
└── index.html            # Landing page served by Caddy

modules/
├── tools.nix             # System packages (curl, git, htop, jq, neovim, ripgrep, etc.)
└── services/             # Custom NixOS service modules
    ├── homeassistant.nix
    ├── monitoring.nix
    └── fava.nix
```

### Custom Service Module Pattern

All custom services follow this pattern:

1. Define options using `mkOption` and `mkEnableOption` under `options.services.<name>`
2. Implementation in `config = mkIf cfg.enable { ... }`
3. Create systemd services with proper dependencies and paths
4. Services are configured in `hosts/mel/custom-services.nix` by setting options

Example:

```nix
services.fava = {
  enable = true;
  port = 5000;
  repoUrl = "git@github.com:jakobhellermann/finances.git";
  beancountFile = "journal.beancount";
};
```

### Service Architecture

**Home Assistant** (port 8123)

- Runs as OCI container (ghcr.io/home-assistant/home-assistant:stable)
- Host networking mode for device discovery
- Persistent data in `/var/lib/homeassistant/` (must be backed up manually)
- Accessed via `/homeassistant` path on Caddy

**Monitoring Stack** (ports 3000, 3100, 9090)

- Grafana (3000): Pre-provisioned with Node Exporter dashboard
- Loki (3100): Log aggregation from systemd journal via Alloy
- Prometheus (9090): Metrics collection with remote write capability
- Alloy: Forwarding agent (journal → Loki, node-exporter → Prometheus)
- Node Exporter (9100): System metrics
- Accessed via `/grafana` path on Caddy

**Fava** (port 5000)

- Python-based Beancount web interface using `uv` for dependency management
- Syncs from private GitHub repo on service start (fetch + hard reset)
- Uses SSH key authentication (generated by `setup-github-key` systemd service)
- SSH key persisted in `/persist/ssh/github_id_ed25519`
- Accessed via `/beancount` path on Caddy

### Networking & Access

- Server accessible at `mel.local` via mDNS (Avahi)
- WiFi configured for "FRITZ!Box 6660 Cable TO" network
- Firewall allows: 22 (SSH), 80 (HTTP), 443 (HTTPS), 5353 (mDNS)
- Caddy reverse proxy routes external traffic to services (all services bind to localhost only)
- SSH authentication via authorized_keys (password auth disabled)
- Root and `mel` user share same SSH keys

### Persistence & State

- Disko manages disk partitioning declaratively
- Important persisted data locations:
  - `/var/lib/homeassistant/` - Home Assistant configuration and database
  - `/var/lib/grafana/` - Grafana dashboards and settings
  - `/persist/ssh/` - GitHub SSH key for Fava
  - `/var/lib/fava/` - Cloned finance repository

### GitHub Integration

The `setup-github-key` systemd service (runs before Fava):

1. Generates SSH key at `/persist/ssh/github_id_ed25519` (if not exists)
2. Symlinks to `/root/.ssh/id_ed25519`
3. Prints public key to journal on first run (add to GitHub deploy keys)

## Important Notes

- **Destructive Operations**: `just provision` will wipe the target server. Always use `just deploy` for updates.
- **Secrets Management**: WiFi password and service credentials are currently in plaintext in configuration.nix
- **Backups**: No automatic backup configuration. Manually back up persistent data directories before major changes.
- **Service Isolation**: All services currently run as root or with elevated privileges
- **Python Dependencies**: Fava uses `uv` to manage Python packages. `programs.nix-ld.enable = true` is required for dynamic binaries.

## Modifying Services

When changing service modules:

1. Update the module in `modules/services/<name>.nix`
2. Modify options in `hosts/mel/custom-services.nix` if needed
3. Run `just deploy` to apply changes
4. Check service status: `just ssh systemctl status <service-name>`
5. View logs: `just ssh journalctl -u <service-name> -f`

When adding new services:

1. Create module in `modules/services/<name>.nix` following existing pattern
2. Import module in `hosts/mel/custom-services.nix`
3. Enable and configure service in `hosts/mel/custom-services.nix`
4. Add Caddy reverse proxy route in `hosts/mel/configuration.nix` if web-accessible
5. Update firewall rules if service needs direct external access
